# 주문, 체결, 정산 과정에서 발생하는 동시성 문제 해결

---

이 글에서는 가상 자산 거래 프로젝트의 핵심 로직인 주문, 체결, 정산 과정에서 발생하는 동시성 이슈를 식별하고,
이를 해결한 과정을 기술합니다.
<br></br>

### 📌 동시성 이슈가 발생하는 핵심 구간:
사용자의 자산을 다루는 거래 시스템에서는 데이터의 정합성과 무결성이 매우 중요합니다. 하지만 여러 요청이
동시에 처리될 때, 본 프로젝트의 다음과 같은 구간에서 동시성 문제가 발생할 수 있습니다.

### 1. 매수/매도 주문 생성 시 자산 동결
사용자가 매수/매도 주문을 생성하면, 거래가 체결되기 전까지 해당 자산을 다른 곳에 사용할 수 없도록 동결해야 합니다.
- 매수 주문: 사용자의 잔액을 확인하고, 주문 금액만큼을 lockBalance로 설정하여 동결하는 과정에서 여러 
요청이 동시에 발생하면 데이터 부정합이 생길 수 있습니다.
- 매도 주문: 사용자가 보유한 가상 자산을 확인하고, 주문 수량만큼 lockQuantity를 설정하는 과정 역시 
동일한 동시성 문제에 노출됩니다.

### 2. 체결 수량(filledQuantity) 업데이트
- 하나의 주문이 여러 건으로 분할 체결될 때, 각 체결 건이 동시에 filledQuantity를 업데이트하면 일부 체결
내역이 누락될 수 있습니다.

### 3. 정산 시 사용자 잔고 변경
- 체결이 완료된 여러 주문에 대한 정산이 동시에 진행될 경우, 사용자의 최종 잔고(원화 또는 가상 자산)를 업데이트하는
과정에서 데이터가 올바르게 반영되지 않는 문제가 발생할 수 있습니다.
<br></br>


### 📌 각 구간 별 동시성 문제 해결 과정:
주문 생성, 체결, 정산 과정에서는 각기 다른 비즈니스 로직과 상황으로 인해 다양한 동시성 문제가 발생할 수 있습니다.
따라서 각 구간의 특성을 고려하여 서로 다른 해결 방법을 적용했습니다. <br>

첫 번째로, 매수/매도 주문 생성 단계에서는 한 명의 사용자가 거의 동시에 매수와 매도 주문을 요청할 때 동시성 문제가 
발생할 수 있습니다. 하지만 이는 실제 서비스에서 발생하기 매우 드문, 경합 조건이 지극히 한정적인 상황입니다.
이러한 특수성을 고려하여, 사용자의 잔액을 조회하는 시점에 비관적 락(Pessimistic Lock)을 적용하는 것만으로도
문제를 충분히 해결할 수 있다고 판단했습니다. <br>




